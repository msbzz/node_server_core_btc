const fs = require('fs');
const path = require('path');
const axios = require('axios');
const { DATADIR, WALLET } = require('./index');

const RPC_URL  = process.env.BITCOIN_RPC_URL || 'http://127.0.0.1:18332';

const RPC_USER = process.env.BITCOIN_RPC_USER || 'lnd';
const RPC_PASS = process.env.BITCOIN_RPC_PASS || 'lndpass123';

const USE_USERPASS = Boolean(RPC_USER && RPC_PASS);
let currentAuth = null;
const cookiePath = path.join(DATADIR, 'regtest', '.cookie');

function readCookieAuth() {
  const raw = fs.readFileSync(cookiePath, 'utf8').trim();
  const [u, p] = raw.split(':');
  return { username: u, password: p };
}

if (USE_USERPASS) {
  currentAuth = { username: RPC_USER, password: RPC_PASS };
} else {
  if (!fs.existsSync(cookiePath)) {
    console.error('Cookie do Core n√£o encontrado:', cookiePath);
    process.exit(1);
  }
  currentAuth = readCookieAuth();
}

function makeRpcClient(wallet = WALLET) {
  return axios.create({
    baseURL: `${RPC_URL}/wallet/${encodeURIComponent(wallet)}`,
    headers: { 'Content-Type': 'application/json' },
    auth: currentAuth,
    timeout: 8000,
  });
}

module.exports = { makeRpcClient, readCookieAuth, USE_USERPASS, currentAuth, cookiePath, WALLET };
